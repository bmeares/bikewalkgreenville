### See https://meerschaum.io/reference/compose/ for the compose schema.

project_name: who-owns-the-roads

root_dir: ../root

plugins_dir:
- ../.installed_plugins
- ../plugins

sync:
  schedule: "daily"

isolation: 'subprocess'

pipes:

- connector: "sql:bwg"
  metric: "contact_info"
  location: "Roads"
  parameters:
    target: "contact_info"
    columns:
      jcode: "JCODE"
      feat_code: "FEAT_CODE"
      owner: "owner"
    schema: "Roads"
    sql: |-
      SELECT *
      FROM (
        VALUES
        (45045, 1370, 'SCDOT', 'N/A', 'https://apps.scdot.org/mwro/', '(864) 241-1224'),
        (45045, 1371, 'SCDOT', 'N/A', 'https://apps.scdot.org/mwro/', '(864) 241-1224'),
        (45045, 1372, 'SCDOT', 'N/A', 'https://apps.scdot.org/mwro/', '(864) 241-1224'),
        (45045, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (27070, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (30850, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (30985, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (37149, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (45115, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (66580, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (72430, 1373, 'Greenville County', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (30850, 1374, 'City of Greenville', 'cares@greenvillesc.gov', 'https://survey123.arcgis.com/share/daf25398c6254883aab80a31c7e142ce', '(864) 232-2273'),
        (30985, 1374, 'City of Greer', 'public-services@cityofgreersc.gov', 'https://gree.csqrcloud.com/community-etrakit/CRM/issue.aspx', '(864) 848‚Äê2184'),
        (45115, 1374, 'City of Mauldin', 'mauldinpublicworks@mauldincitysc.com', 'https://cityofmauldin.org/service-request-form/', '(864) 289-8904'),
        (27070, 1374, 'City of Fountain Inn', 'fred.wilson@fountaininn.org', 'https://simpsonvillesc.mycusthelp.com/WEBAPP/_rs/(S(kv5landczq0lgxpr1apw4zis))/Requestselect.aspx?sSessionID=', '(864) 531-0644'),
        (66580, 1374, 'City of Simpsonville', 'info@simpsonville.com', 'https://www.simpsonville.com/contact/', '(864) 967-9531'),
        (72430, 1374, 'City of Travelers Rest', 'tate@travelersrestsc.com', 'https://travelersrestsc.com/businesses/departments/public-works/report-a-problem/', '(864) 834-8740'),
        (NULL, 1373, 'Greenville County & ReWa', 'N/A', 'https://www.greenvillecounty.org/apps/servicerequest/Request.aspx', '(864) 467-7016'),
        (NULL, NULL, 'Conestee Nature Preserve', 'info@conesteepreserve.org', 'https://www.conesteepreserve.org/', '(864) 277-2004'),
        (NULL, 1373, 'Laurens County', 'ahoward@laurenscountysc.gov', 'https://www.laurenscountysc.gov/departments/parks_recreation_and_tourism/index.php', '(864) 984-5484')
      ) AS t ("JCODE", "FEAT_CODE", "owner", "email", "url", "phone")

- connector: "sql:bwg"
  metric: "road_types"
  location: "Roads"
  parameters:
    schema: Roads
    target: road_types
    columns:
      feat_code: "FEAT_CODE"
      road_type: road_type
    dtypes:
      FEAT_CODE: "int"
      road_type: "string"
    sql: |-
      SELECT *
      FROM (
        VALUES
        (1370, 'Interstate Highway'),
        (1371, 'US Highway'),
        (1372, 'State Road'),
        (1373, 'County Road'),
        (1374, 'Municipal Road'),
        (1375, 'Subdivision'),
        (1376, 'Private Drive')
      ) AS t ("FEAT_CODE", "road_type")

- connector: "sql:bwg"
  metric: "jcodes_road_types"
  location: "Roads"
  parameters:
    columns:
      jcode: "JCODE"
      road_type: "road_type"
    schema: "Roads"
    target: jcodes_road_types
    sql: |-
      SELECT DISTINCT "JCODE", road_type
      FROM county."TRA_STREETCL" AS cl
      LEFT JOIN "Roads".road_types AS r
        ON r."FEAT_CODE" = cl."FEAT_CODE"

- connector: "sql:bwg"
  metric: "srt"
  location: "Roads"
  parameters:
    schema: "Roads"
    target: "srt_roads"
    columns:
      primary: "Facility ID"
      type: "Type"
      name: "Name"
    dtypes:
      geometry: geometry[MULTIPOLYGON, 6570]
    indices:
      geometry: "geometry"
    sql: |-
      SELECT
        NULL::DATE AS "Last Edited",
        NULL::TEXT AS "Created",
        t."road_type" AS "Type",
        s."Segment" || ' | PRISMA Health Swamp Rabbit Trail' AS "Name",
        'SRT-' || s."Segment" || '-' || s."Owner" AS "Facility ID",
        ST_Transform(ST_Force2D(s.geometry), 6570) AS "geometry",
        ST_Length(ST_Transform(ST_Force2D(s.geometry), 6570)) AS "Length (ft)",
        s."Owner",
        s."Online Form",
        s."Email",
        s."Phone"
      FROM "SRT".segments_owners AS s
      INNER JOIN "Roads".road_types AS t
        ON t."FEAT_CODE" = s."FEAT_CODE"

- connector: "sql:bwg"
  metric: "roads"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads
    columns:
      primary: "Facility ID"
      type: "Type"
      name: "Name"
    dtypes:
      geometry: geometry[MULTILINESTRING, 6570]
    indices:
      geometry: geometry
    sql: |-
      SELECT
        "created_da"::TEXT AS "Created",
        "last_edi_1"::DATE AS "Last Edited",
        r.road_type AS "Type",
        SMART_CAPITALIZE("LABEL") AS "Name",
        "FACILITYID" AS "Facility ID",
        "geometry",
        ST_Length("geometry") AS "Length (ft)",
        c.owner AS "Owner",
        c.url AS "Online Form",
        c.email AS "Email",
        c.phone AS "Phone"
      FROM county."TRA_STREETCL" AS cl
      LEFT JOIN "Roads".road_types AS r
        ON r."FEAT_CODE" = cl."FEAT_CODE"
      LEFT JOIN "Roads".contact_info AS c
        ON c."FEAT_CODE" = cl."FEAT_CODE"
        AND COALESCE(c."JCODE", 0) = CASE
          WHEN cl."FEAT_CODE" = 1374 THEN
            -- For FEAT_CODE 1374 (Municipal Road):
            CASE
              -- Use LCITYCODE if it's not null and not 45045.
              WHEN cl."LCITYCODE"::INT IS NOT NULL AND cl."LCITYCODE"::INT != 45045 THEN cl."LCITYCODE"::INT
              -- Edge case: If LCITYCODE, RCITYCODE, and JCODE are all 45045, AND LOCATION is 'GV',
              -- then use 30850 (JCODE for City of Greenville). This handles specific municipal road scenarios.
              WHEN cl."LCITYCODE"::INT = 45045 AND cl."RCITYCODE"::INT = 45045 AND COALESCE(cl."JCODE"::INT, 0) = 45045 AND cl."LOCATION" = 'GV' THEN 30850
              -- If LCITYCODE is null or 45045, AND RCITYCODE is also 45045, then fall back to JCODE.
              WHEN cl."RCITYCODE"::INT = 45045 THEN COALESCE(cl."JCODE"::INT, 0)
              -- Otherwise (LCITYCODE is null/45045 and RCITYCODE is not 45045), use RCITYCODE.
              ELSE cl."RCITYCODE"::INT
            END
          WHEN cl."FEAT_CODE" IN (1370, 1371, 1372) THEN 45045 -- For these specific FEAT_CODEs, always use 45045.
          ELSE COALESCE(cl."JCODE"::INT, 0) -- For all other FEAT_CODEs, use JCODE from TRA_STREETCL, defaulting to 0.
        END
      UNION ALL
      SELECT
        "Created"::TEXT,
        "Last Edited"::DATE,
        "Type",
        "Name",
        "Facility ID",
        "geometry",
        "Length (ft)",
        "Owner",
        "Online Form",
        "Email",
        "Phone"
      FROM "Roads".srt_roads

- connector: "sql:bwg"
  metric: "roads_deltas"
  location: "Roads"
  parameters:
    schema: "Roads"
    target: roads_deltas
    columns:
      datetime: "Last Edited"
      facility_id: "Facility ID"
    sql: |-
      SELECT *
      FROM "Roads".roads

- connector: "sql:bwg"
  metric: "roads_clip"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_clip
    columns:
      primary: "Facility ID"
      road_type: "Type"
    dtypes:
      geometry: geometry[MULTILINESTRING, 6570]
    indices:
      geometry: geometry
      name: "Name"
    sql: |-
      SELECT
        r."Type",
        r."Name",
        r."Facility ID",
        ST_Intersection(r."geometry", b."geometry") AS "geometry",
        ST_Length(ST_Intersection(r."geometry", b."geometry")) AS "Length (ft)",
        "Owner",
        "Online Form",
        "Email",
        "Phone"
      FROM
        "Roads"."roads" r
      JOIN
        "Boundaries"."boundaries_greenville_county" b
        ON
          ST_Intersects(r."geometry", b."geometry")
 
- connector: "sql:bwg"
  metric: "roads_interstate_highway"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_interstate_highway
    columns:
      primary: "Facility ID"
    indices:
      geometry: geometry
      name: "Name"
      road_type: "Type"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('Interstate Highway')

- connector: "sql:bwg"
  metric: "roads_us_highway"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_us_highway
    columns:
      primary: "Facility ID"
    indices:
      geometry: geometry
      name: "Name"
      road_type: "Type"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('US Highway')

- connector: "sql:bwg"
  metric: "roads_state_road"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_state_road
    columns:
      primary: "Facility ID"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('State Road')

- connector: "sql:bwg"
  metric: "roads_interstate_us_state"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_interstate_us_state
    columns:
      primary: "Facility ID"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('Interstate Highway', 'US Highway', 'State Road')

- connector: "sql:bwg"
  metric: "roads_county_road"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_county_road
    columns:
      primary: "Facility ID"
    sql: |-
      SELECT
          r."Facility ID",
          r."Name",
          r."Type",
          r."geometry",
          r."Length (ft)",
          r."Owner",
          r."Online Form",
          r."Email",
          r."Phone",
          string_agg(b.district_num::text, ', ') AS "Council District"
      FROM
          "Roads".roads_clip AS r
      LEFT JOIN
          "Boundaries".county_council_districts AS b ON ST_Intersects(r.geometry, b.geometry)
      WHERE
          "Type" IN ('County Road')
      GROUP BY
          r."Facility ID",
          r."Name",
          r."Type",
          r."geometry",
          r."Length (ft)",
          r."Owner",
          r."Online Form",
          r."Email",
          r."Phone"

- connector: "sql:bwg"
  metric: "roads_municipal_road"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_municipal_road
    columns:
      primary: "Facility ID"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('Municipal Road')

- connector: "sql:bwg"
  metric: "roads_subdivision"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_subdivision
    columns:
      primary: "Facility ID"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('Subdivision')

- connector: "sql:bwg"
  metric: "roads_private_drive"
  location: "Roads"
  parameters:
    schema: Roads
    target: roads_private_drive
    columns:
      primary: "Facility ID"
    sql: |-
      SELECT
          "Name",
          "Type",
          "Facility ID",
          "geometry",
          "Length (ft)",
          "Owner",
          "Online Form",
          "Email",
          "Phone"
      FROM "Roads"."roads_clip"
      WHERE "Type" IN ('Private Drive')

- connector: "sql:bwg"
  metric: "road_total_lengths"
  location: "Roads"
  parameters:
    schema: Roads
    target: road_total_lengths
    columns:
      road_type: Type
    sql: |-
      SELECT "Type", SUM("Length (ft)") AS "Total Length (ft)"
      FROM "Roads".roads
      GROUP BY "Type"

- connector: "sql:bwg"
  metric: "road_total_lengths_miles"
  location: "Roads"
  parameters:
    schema: Roads
    target: road_total_lengths_miles
    columns:
      road_type: Type
    sql: |-
      SELECT
        "Type",
        ("Total Length (ft)" / 5280) AS "Total Length (miles)"
      FROM "Roads".road_total_lengths

### Felt Layers

- connector: "sql:bwg"
  metric: "boundaries"
  location: "greenville"
  instance: "sql:boundaries"
  parameters:
    target: "Greenville"
    columns:
      municipality_name: "Municipality Name"
    dtypes:
      geometry: "geometry[MULTIPOLYGON, 6570]"
    sql: |-
      SELECT *
      FROM "Boundaries"."boundaries_greenville"

- connector: "sql:bwg"
  metric: "boundaries"
  location: "simpsonville"
  instance: "sql:boundaries"
  parameters:
    target: "Simpsonville"
    columns:
      municipality_name: "Municipality Name"
    dtypes:
      geometry: "geometry[MULTIPOLYGON, 6570]"
    sql: |-
      SELECT *
      FROM "Boundaries"."boundaries_simpsonville"

- connector: "sql:bwg"
  metric: "boundaries"
  location: "mauldin"
  instance: "sql:boundaries"
  parameters:
    target: "Mauldin"
    columns:
      municipality_name: "Municipality Name"
    dtypes:
      geometry: "geometry[MULTIPOLYGON, 6570]"
    sql: |-
      SELECT *
      FROM "Boundaries"."boundaries_mauldin"

- connector: "sql:bwg"
  metric: "boundaries"
  location: "greer-clipped"
  instance: "sql:boundaries"
  parameters:
    target: "Greer"
    columns:
      municipality_name: "Municipality Name"
    dtypes:
      geometry: "geometry[MULTIPOLYGON, 6570]"
    sql: |-
      SELECT *
      FROM "Boundaries"."boundaries_greer-clipped"

- connector: "sql:bwg"
  metric: "boundaries"
  location: "fountain-inn-clipped"
  instance: "sql:boundaries"
  parameters:
    target: "Fountain Inn"
    columns:
      municipality_name: "Municipality Name"
    dtypes:
      geometry: "geometry[MULTIPOLYGON, 6570]"
    sql: |-
      SELECT *
      FROM "Boundaries"."boundaries_fountain-inn-clipped"

- connector: "sql:bwg"
  metric: "boundaries"
  location: "travelers_rest"
  instance: "sql:boundaries"
  parameters:
    target: "Travelers Rest"
    columns:
      municipality_name: "Municipality Name"
    dtypes:
      geometry: "geometry[MULTIPOLYGON, 6570]"
    sql: |-
      SELECT *
      FROM "Boundaries"."boundaries_travelers_rest"


config:
  meerschaum:
    instance: sql:bwg
    connectors:
      sql:
        bwg: MRSM{meerschaum:connectors:sql:bwg}
        boundaries:
          flavor: geopackage
          database: '{MRSM_ROOT_DIR}/../data/output/boundaries.gpkg'
  plugins:
    bwg:
      data_path: '{MRSM_ROOT_DIR}/../data'
  system:
    experimental:
      cli_daemon: false

environment: {}
