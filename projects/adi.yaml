project_name: adi

root_dir: ../root

plugins_dir:
- ../.installed_plugins
- ../plugins

pipes:

- connector: "plugin:adi"
  metric: "adi"
  location: "sc"
  parameters:
    schema: "ADI"
    target: "adi_sc"
    columns:
      year: "year"
      fips: "FIPS"
      gisjoin: "GISJOIN"
    dtypes:
      "FIPS": "str"

- connector: "plugin:adi"
  metric: "nhghis"
  parameters:
    schema: "ADI"
    target: "nhghis"
    columns:
      year: "year"
      gisjoin: "GISJOIN"
      geoid: "GEOID"
      countyfp: "COUNTYFP"
      statefp: "STATEFP"
    dtypes:
      geometry: "geometry[MultiPolygon, 5070]"
      ALAND: "int"
      AWATER: "int"
      INTPTLAT: "numeric"
      INTPTLON: "numeric"
      year: "int"
    indices:
      geometry: "geometry"
    fetch:
      backtrack_minutes: 0

- connector: "sql:bwg"
  metric: "adi"
  location: "sc"
  parameters:
    schema: "ADI"
    target: "adi_sc_geom"
    columns:
      year: "year"
      gisjoin: "GISJOIN"
    dtypes:
      "FIPS": "string"
      geometry: "geometry[MultiPolygon]"
    indices:
      fips: "FIPS"
      geometry: "geometry"
    sql: |-
      SELECT
        a."year",
        a."GISJOIN",
        a."FIPS",
        a."ADI_STATERNK",
        a."ADI_NATRANK",
        ST_Transform(n."geometry", 4326) AS "geometry"
      FROM "ADI".adi_sc AS a
      INNER JOIN "ADI".nhghis AS n
        ON n."year" = a."year"
        AND n."GISJOIN" = SUBSTRING(a."GISJOIN", 1, 14)

config:
  meerschaum:
    instance: sql:bwg
    connectors:
      sql:
        bwg: MRSM{meerschaum:connectors:sql:bwg}
  plugins:
    bwg:
      data_path: '{MRSM_ROOT_DIR}/../data'
