### See https://meerschaum.io/reference/compose/ for the compose schema.

project_name: parking

root_dir: ../root

plugins_dir:
- ../.installed_plugins
- ../plugins

sync:
  schedule: "daily"

pipes:

- connector: "sql:bwg"
  metric: "parking"
  location: "county"
  parameters:
    schema: "Parking"
    target: "parking_county"
    columns:
      primary: "GlobalID"
    sql: |-
      SELECT
        CASE
          WHEN "FEAT_CODE" = 880 THEN 'Paved parking'
          WHEN "FEAT_CODE" = 881 THEN 'Un-paved parking'
          WHEN "FEAT_CODE" = 882 THEN 'Not a parking polygon'
        END AS "polygon_type",
        "GlobalID",
        "SHAPE_STAr" AS "shape_area",
        "SHAPE_STLe" AS "shape_length",
        "geometry"
      FROM county."PLN_PARKING"
      WHERE "FEAT_CODE" != 882

- connector: "sql:bwg"
  metric: "parking"
  location: "city"
  parameters:
    schema: "Parking"
    target: parking_city
    columns:
      primary: "id"
    dtypes:
      geometry: "geometry[3361]"
    sql: |-
      SELECT *,
        CASE 
          WHEN "FEAT_CODE" = 121 THEN 'Paved'
          WHEN "FEAT_CODE" = 122 THEN 'Unpaved'
          WHEN "FEAT_CODE" = 123 THEN 'Background'
          WHEN "FEAT_CODE" = 124 THEN 'Residential Driveway'
          WHEN "FEAT_CODE" = 127 THEN 'Under Construction'
          ELSE 'Unknown'
        END AS "type"
      FROM city."Parking"

- connector: "sql:bwg"
  metric: "parking"
  location: "dtmp"
  parameters:
    schema: "Parking"
    target: "dtmp_parking"
    columns:
      primary: "id"
    dtypes:
      geometry: "geometry[polygon, 3361]"
      id: "int"
    indices:
      geometry: "geometry"
      feat_code: "FEAT_CODE"
    sql: |-
      SELECT p.*
      FROM "Boundaries"."DTMP_STUDYAREA_2019_POLY" AS dt
      JOIN "city"."Parking" AS p
        ON ST_Intersects(ST_MakeValid(dt.geom), ST_MakeValid(p.geometry))

config:
  meerschaum:
    instance: sql:bwg
    connectors:
      sql:
        bwg: MRSM{meerschaum:connectors:sql:bwg}
  plugins:
    bwg:
      data_path: '{MRSM_ROOT_DIR}/../data'

environment: {}
